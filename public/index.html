<!DOCTYPE html>
<html>

<head>
	<title>CollaboWriter</title>
	<link href='http://fonts.googleapis.com/css?family=Special+Elite' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="css/style.css">
</head>

<body>
	<textarea id="pad" autofocus="">Connecting...</textarea>
		
	<button id="get-version-btn">Previous version</button>
	<input id="version-slider" type="range" min="0" step="1" onchange="printValue('version-slider','version-box')">
	<input id="version-box" type="text" size="2">

	<script src="js/sharejs/text.js"></script>
	<script src="js/sharejs/share.uncompressed.js"></script>
	<script>
		var pad = document.getElementById('pad');

		var socket = new WebSocket('ws://' + window.location.host);
		var sharejs = new window.sharejs.Connection(socket);

		var doc = sharejs.get('masterpieces', 'first draft');
		doc.subscribe();

		doc.whenReady(function () {
			if (!doc.type) doc.create('json0');
			if (doc.type && doc.type.name === 'json0') {

				if (!doc.snapshot) {
					var context = doc.createContext();
					var myObject = {
						text: "Enter some text here..."
					};
					context.set(myObject);
				}
				doc.attachTextarea(pad);
				initSlider(doc.version);
				doc.on('get version', function (msg) {
					var text = msg.data.text;
					console.log('version [' + msg.v + ']: ' + text);
					pad.value = text;
				});
			}
		});

		var version = doc.version;
		document.getElementById('get-version-btn').addEventListener('click', function (evt) {
			if (pad.readOnly) {
				pad.removeAttribute('readonly');
				doc.getSnapshotAtRevision(doc.version);
				evt.target.innerHTML = 'Previous version';
			} else {
				pad.readOnly = true;
				if (doc.version > 2) {
					doc.getSnapshotAtRevision(doc.version - 2);
				}
				evt.target.innerHTML = 'Current version';
			}
		});

		function printValue(sliderID, textboxId) {
			var textBox = document.getElementById(textboxId);
			var slider = document.getElementById(sliderID);
			textBox.value = slider.value;
				
			pad.readOnly = true;
				if (slider.value) {
					doc.getSnapshotAtRevision(+slider.value);
				}
		}

		function initSlider(maxValue) {
			var slider = document.getElementById("version-slider");
			slider.max = maxValue;
			slider.value = slider.max;
			printValue('version-slider', 'version-box');
		}
	</script>
</body>

</html>
